# Репозиторий с кодом для отбора признаков, обучения, дообучения модели прогнозирования временного ряда.

## Файлы
- `project_ts_1.ipynb` - ноутбук с EDA и основной исследовательской работой. В нем приведен анализ доступных данных: стационарность временного ряда, построение ARIMA модели, скрипты сравнения методов отбора признаков и моделей
- `main.py` - файл основного скрипта автоматизированного пайплайна 
- `preprocessing.py` - файл со скриптом препроцессинга датасета (добавление доп фичей, генерация признаков, первичный отбор)
- `feature_selection.py` - файл со скриптом наиболее стабильного по результатам анализа метода отбора признаков
- `fitting_model.py` - файл со скриптом обучения наилучшей полученной после сравнения моделей
- `changepoints_detection.py` - файл со скриптом детекции разладок
- `requirements.txt` - версии библиотек, необходимые для запуска кода

## Применение

Для обучения модели в main.py ставится флаг train_task = True  
Для получения предикта необходимо поставить в main.py флаг get_prediction_task = True и предоставить доступ к файлу с новыми данными за день для получения предсказания  

Модель дообучается раз в квартал, так как в целом ряд стационарен и модель не требует частой корректировки. Период раз в квартал выбран для сохранения out-of-time выборки в размере 3 месяцев.  
Для переобучения модели в main.py ставится флаг refit_task = True и предоставляется доступ к данным за новые три месяца.

При получении новых данных (в случае применения модели на новых данных или запросе на ее переобучение) проводится проверка на разладки, если она обнаруженаБ то будет выдана ошибка с призывом переобучить модель вручную из-за сдвига в данных.  

## Описание работы 

Для разработки модели мы добавили к исходным данным информацию о ключевой ставке ЦБ РФ и уровне инфляции на дату (данные ЦБ РФ), налоговые даты (28 число каждого месяца).  
Были сгененрированы дополнительные признаки с помощью библиотки TSFresh.  

Был проведен анализ ряда на стационарность с помощью ACF, PACF, ADF-test. По графикам ACF, PACF была обнаружена полугодовая сезонность, ADF-test отверг гипотезу нестационарности ряда, поэтому в качестве бейзлайна была обучена модель AUTO-ARIMA. 

В качестве методов отбора признаков были рассмотрены:
- отбор по корреляции признаков между собой (выкинуть сильно скоррелированные)
- отбор по корреляции признаков с таргетом (взять только те, которые коррелируют больше, чем порог)
- отбор RFE
- отбор LASSO
- отбор встроенным методом feature_selection в CatBoost
- кастомный метод отбора, объединяющий отбор по корреляции, RFE и LASSO

Выбран метод отбора по корреляции с таргетом как самый стабильный.

В качестве оптимизируемой метрики в соответствии с запросом бизнеса на абсолютную величину ошибки выбрана метрика MAE.

Выборка была разбита на train/val/oot (out-of-time с начала 2021 года) без перемешивания для сохранения временной структуры ряда.

Модели обучались на отобранных фичах с подбором гиперпарметров на валидационной выборке с помощью Optuna.

Рассматривались такие модели, как:
- Ridge regression
- catboost regressor
- prophet

Лучшей моделью с точки зрения качества на OOT выборке оказалась модель Ridge. 



